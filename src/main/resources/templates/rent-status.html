<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>구독 상태</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 40px;
    }

    h1 {
      text-align: center;
      color: #333;
    }

    h3 {
      text-align: center;
      color: #333;
      margin-bottom: 50px;
    }

    .subscription-card {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      margin: 20px auto;
      max-width: 600px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .subscription-card p {
      margin: 5px 0;
    }

    .cancel-button {
      margin-top: 10px;
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }

    .cancel-button:hover {
      background-color: #c0392b;
    }
  </style>
</head>
<body>
  <h1>내 구독 현황</h1>
  <h3>현재 사용자: <span th:text="${uid}">알 수 없음</span></h3>

	<!-- 구독 완료 알림 -->
    <div th:if="${subscribeSuccess}">
      <script>alert('신청이 완료되었습니다.');</script>
    </div>

	<div th:if="${cancelSuccess}">
    <script>alert('구독이 해지되었습니다.');</script>
  	</div>
  
  <!-- 서버에서 rentList만 내려줌 -->
  <div th:each="rent : ${rentList}" class="subscription-card" th:attr="data-oaccno=${rent.oaccNo}">
    <p><strong>플랫폼: <span class="otype"></span></strong></p>
    <p>계정 ID: <span class="email"></span></p>
    <p>계정 비밀번호: <span class="password"></span></p>
    <p>시작일: <span th:text="${rent.rstart}"></span></p>
    <p>만료일: <span th:text="${rent.rexpiry}"></span></p>

    <form th:action="@{/rent/cancel}" method="post">
      <input type="hidden" name="rentNo" th:value="${rent.rentNo}" />
      <input type="hidden" name="userno" th:value="${userno}" />
      <button type="submit" class="cancel-button">구독 취소</button>
    </form>
  </div>

  <!--  OTT 계정 정보 + 플랫폼명 매핑 -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const [accRes, typeRes] = await Promise.all([
          fetch('/ott-acc'),      // OTT 계정 정보
          fetch('/api/ott')           // 플랫폼 번호 → 이름 매핑
        ]);

        const ottAccounts = await accRes.json(); // [{ oaccNo, ottNo, email, password }]
        const ottTypes = await typeRes.json();   // [{ ottNo, otype }]

        const ottTypeMap = {};
        ottTypes.forEach(type => {
          ottTypeMap[type.ottNo] = type.otype;
        });

        const cardList = document.querySelectorAll('.subscription-card');

        cardList.forEach(card => {
          const oaccNo = card.getAttribute('data-oaccno');
          const matched = ottAccounts.find(acc => acc.oaccNo == oaccNo);

          if (matched) {
            card.querySelector('.email').textContent = matched.email;
            card.querySelector('.password').textContent = matched.password;
            card.querySelector('.otype').textContent = ottTypeMap[matched.ottNo] || '알 수 없음';
          } else {
            card.querySelector('.email').textContent = '정보 없음';
            card.querySelector('.password').textContent = '정보 없음';
            card.querySelector('.otype').textContent = '정보 없음';
          }
        });
      } catch (err) {
        console.error('데이터 불러오기 실패:', err);
      }
    });
  </script>
</body>
</html>

